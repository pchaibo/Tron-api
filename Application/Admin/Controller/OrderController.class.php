<?php/** * Created by PhpStorm. * User: gaoxi * Date: 2017-04-02 * Time: 23:01 */namespace Admin\Controller;use Think\Page;/** * 订单管理控制器 * Class OrderController * @package Admin\Controller */class OrderController extends BaseController{    public function __construct()    {        parent::__construct();    }    /**     * 订单列表     */    public function index()    {        //银行        $tongdaolist = M("Channel")->field('id,code,title')->select();        $this->assign("tongdaolist", $tongdaolist);        //通道        $banklist = M("Product")->field('id,name,code')->select();        $this->assign("banklist", $banklist);        $where = array();        $memberid = I("request.memberid");        if ($memberid) {            $where['pay_memberid'] = array('eq',$memberid);        }        $orderid = I("request.orderid");        if ($orderid) {            $where['out_trade_id'] = $orderid;        }        $ddlx = I("request.ddlx","");        if($ddlx != ""){            $where['ddlx'] = array('eq',$ddlx);        }        $tongdao = I("request.tongdao");        if ($tongdao) {            $where['pay_bankcode'] = array('eq',$tongdao);        }        $bank = I("request.bank",'','strip_tags');        if ($bank) {           // $where['pay_tongdao'] = array('eq',$bank);        }        //银行名        $pay_zh_tongdao = I("request.bank",'','strip_tags');        if ($pay_zh_tongdao) {            $where['pay_zh_tongdao'] = array('eq',$pay_zh_tongdao);        }       // print_r($pay_zh_tongdao);                $status = I("request.status");        if ($status!="") {            $where['pay_status'] = array('eq',$status);        }        $createtime = urldecode(I("request.createtime"));        if ($createtime) {            list($cstime,$cetime) = explode('|',$createtime);            $where['pay_applydate'] = ['between',[strtotime($cstime),strtotime($cetime)?strtotime($cetime):time()]];        }        $successtime = urldecode(I("request.successtime"));        if ($successtime) {            list($sstime,$setime) = explode('|',$successtime);            $where['pay_successdate'] = ['between',[strtotime($sstime),strtotime($setime)?strtotime($setime):time()]];        }        $count = M('Order')->where($where)->count();        $page = new Page($count,15);        $list = M('Order')            ->where($where)            ->limit($page->firstRow.','.$page->listRows)            ->order('id desc')            ->select();        $amount = $rate = $realmoney = 0;        foreach ($list as $item){            if($item['pay_status'] >=1){                $amount += $item['pay_amount'];                $rate += $item['pay_poundage'];                $realmoney += $item['pay_actualamount'];            }        }        $this->assign('status',$status);        $this->assign('pay_zh_tongdao',$pay_zh_tongdao);        $this->assign("list", $list);        $this->assign('stamount',$amount);        $this->assign('page',$page->show());        $this->assign('strate',$rate);        $this->assign('strealmoney',$realmoney);        C('TOKEN_ON',false);        $this->display();    }    /**     * 导出交易订单     * */    public function exportorder()    {        $memberid = I("request.memberid");        if ($memberid) {            $where['pay_memberid'] = array('eq',$memberid);        }        $orderid = I("request.orderid");        if ($orderid) {            $where['out_trade_id'] = $orderid;        }        $ddlx = I("request.ddlx","");        if($ddlx != ""){            $where['ddlx'] = array('eq',$ddlx);        }        $tongdao = I("request.tongdao");        if ($tongdao) {            $where['pay_tongdao'] = array('eq',$tongdao);        }        $bank = I("request.bank",'','strip_tags');        if ($bank) {            $where['pay_bankname'] = array('eq',$bank);        }        $status = I("request.status",0,'intval');        if ($status) {            $where['pay_status'] = array('eq',$status);        }        $createtime = urldecode(I("request.createtime"));        if ($createtime) {            list($cstime,$cetime) = explode('|',$createtime);            $where['pay_applydate'] = ['between',[strtotime($cstime),strtotime($cetime)?strtotime($cetime):time()]];        }        $successtime = urldecode(I("request.successtime"));        if ($successtime) {            list($sstime,$setime) = explode('|',$successtime);            $where['pay_successdate'] = ['between',[strtotime($sstime),strtotime($setime)?strtotime($setime):time()]];        }        $title = array('订单号','商户编号','交易金额','手续费','实际金额','提交时间','成功时间','通道','状态');        $data = M('Order')->where($where)->select();        foreach ($data as $item){            switch ($item['pay_status']){                case 0:                    $status = '未处理';                    break;                case 1:                    $status = '成功，未返回';                    break;                case 2:                    $status = '成功，已返回';                    break;            }            $list[] = array(                'pay_orderid'=>"\t".$item['pay_orderid'],                'pay_memberid'=>$item['pay_memberid'],                'pay_amount'=>$item['pay_amount'],                'pay_poundage'=>$item['pay_poundage'],                'pay_actualamount'=>$item['pay_actualamount'],                'pay_applydate'=>date('Y-m-d H:i:s',$item['pay_applydate']),                'pay_successdate'=>date('Y-m-d H:i:s',$item['pay_successdate']),                'pay_zh_tongdao'=>$item['pay_zh_tongdao'],                'pay_status'=>$status,            );        }        exportCsv($list,$title);    }    /**     * 查看订单     */    public function show()    {        $id = I("get.oid",0,'intval');        if($id){            $order = M('Order')                ->join('LEFT JOIN __MEMBER__ ON (__MEMBER__.id + 10000) = __ORDER__.pay_memberid')                ->field('pay_member.id as userid,pay_member.username,pay_member.realname,pay_order.*')                ->where(['pay_order.id'=>$id])                ->find();        }        $this->assign('order',$order);        $this->display();    }    /**     * 资金变动记录     */    public function changeRecord()    {        //通道        $banklist = M("Product")->field('id,name,code')->select();        $this->assign("tongdaolist", $banklist);        $where = array();        $memberid = I("get.memberid");        if ($memberid) {            $where['userid'] = array('eq',($memberid-10000)>0?($memberid-10000):0);        }        $orderid = I("get.orderid");        if ($orderid) {            $where['transid'] = array('eq',$orderid);        }        $tongdao = I("request.tongdao");        if ($tongdao) {            $where['tongdao'] = array('eq',$tongdao);        }        $bank = I("request.bank",'','strip_tags');        if ($bank) {            $where['lx'] = array('eq',$bank);        }        $createtime = urldecode(I("request.createtime"));        if ($createtime) {            list($cstime,$cetime) = explode('|',$createtime);            $where['datetime'] = ['between',[$cstime,$cetime?$cetime:date('Y-m-d')]];        }        $count = M('Moneychange')->where($where)->count();        $page = new Page($count,15);        $list = M('Moneychange')            ->where($where)            ->limit($page->firstRow.','.$page->listRows)            ->order('id desc')            ->select();        $this->assign("list", $list);        $this->assign("page", $page->show());        C('TOKEN_ON',false);        $this->display();    }    /**     * 资金变动记录导出     */    public function exceldownload()    {        $where = array();        $memberid = I("request.memberid");        if ($memberid) {            $where['userid'] = array('eq',($memberid-10000)>0?($memberid-10000):0);        }        $orderid = I("request.orderid");        if ($orderid) {            $where['orderid'] = $orderid;        }        $tongdao = I("request.tongdao");        if ($tongdao) {            $where['tongdao'] = array('eq',$tongdao);        }        $bank = I("request.bank",'','strip_tags');        if ($bank) {            $where['lx'] = array('eq',$bank);        }        $createtime = urldecode(I("request.createtime"));        if ($createtime) {            list($cstime,$cetime) = explode('|',$createtime);            $where['datetime'] = ['between',[$cstime,$cetime?$cetime:date('Y-m-d')]];        }        $list = M("Moneychange")->where($where)->select();        $title = array('订单号','用户名','类型','提成用户名','提成级别','原金额','变动金额','变动后金额','变动时间','通道','备注');        foreach ($list as $key => $value) {            $data[$key]['transid'] = "\t".$value["transid"];            $data[$key]['parentname'] = getParentName($value["tcuserid"], 1);            switch ($value["lx"]) {                case 1:                    $data[$key]['lxstr'] = "付款";                    break;                case 3:                    $data[$key]['lxstr'] = "手动增加";                    break;                case 4:                    $data[$key]['lxstr'] = "手动减少";                    break;                case 6:                    $data[$key]['lxstr'] = "结算";                    break;                case 7:                    $data[$key]['lxstr'] = "冻结";                    break;                case 8:                    $data[$key]['lxstr'] = "解冻";                    break;                case 9:                    $data[$key]['lxstr'] = "提成";                    break;                default:                    $data[$key]['lxstr'] = "未知";            }            $data[$key]['tcuserid'] = getParentName($value["tcuserid"],1);            $data[$key]['tcdengji'] = $value["tcdengji"];            $data[$key]['ymoney'] = $value["ymoney"];            $data[$key]['money'] = $value["money"];            $data[$key]['gmoney'] = $value["gmoney"];            $data[$key]['datetime'] = "\t".$value["datetime"];            $data[$key]['tongdao'] = getProduct($value["tongdao"]);            $data[$key]['contentstr'] = $value["contentstr"];        }        exportCsv($data,$title);    }}?>